+++
title = "锁定 Swarm 以保护其加密密钥"
date = 2024-10-23T14:54:40+08:00
weight = 60
type = "docs"
description = ""
isCJKLanguage = true
draft = false

+++

> 原文：[https://docs.docker.com/engine/swarm/swarm_manager_locking/](https://docs.docker.com/engine/swarm/swarm_manager_locking/)
>
> 收录该文档的时间：`2024-10-23T14:54:40+08:00`

# Lock your swarm to protect its encryption key - 锁定 Swarm 以保护其加密密钥

The Raft logs used by swarm managers are encrypted on disk by default. This at-rest encryption protects your service's configuration and data from attackers who gain access to the encrypted Raft logs. One of the reasons this feature was introduced was in support of the [Docker secrets]({{< ref "/manuals/DockerEngine/Swarmmode/ManagesensitivedatawithDockersecrets" >}}) feature.

​	Swarm 管理节点使用的 Raft 日志默认在磁盘上加密保存。该静态加密保护了您的服务配置和数据，以防攻击者获取加密的 Raft 日志。此功能的引入是为了支持 [Docker 密钥管理]({{< ref "/manuals/DockerEngine/Swarmmode/ManagesensitivedatawithDockersecrets" >}})功能。

When Docker restarts, both the TLS key used to encrypt communication among swarm nodes and the key used to encrypt and decrypt Raft logs on disk are loaded into each manager node's memory. Docker has the ability to protect the mutual TLS encryption key and the key used to encrypt and decrypt Raft logs at rest, by allowing you to take ownership of these keys and to require manual unlocking of your managers. This feature is called autolock.

​	当 Docker 重启时，用于加密 Swarm 节点间通信的 TLS 密钥和用于在磁盘上加密/解密 Raft 日志的密钥会加载到每个管理节点的内存中。Docker 允许您接管这些密钥并要求手动解锁管理节点来保护 TLS 加密密钥和磁盘上静态加密的 Raft 日志密钥，这个功能称为自动锁定（autolock）。

When Docker restarts, you must [unlock the swarm](https://docs.docker.com/engine/swarm/swarm_manager_locking/#unlock-a-swarm) first, using a key encryption key generated by Docker when the swarm was locked. You can rotate this key encryption key at any time.

​	Docker 重启时，您必须先使用 Docker 在 Swarm 锁定时生成的密钥加密密钥 [解锁 Swarm](https://docs.docker.com/engine/swarm/swarm_manager_locking/#unlock-a-swarm)。您可以随时轮换该密钥加密密钥。

> **Note**
>
> 
>
> You don't need to unlock the swarm when a new node joins the swarm, because the key is propagated to it over mutual TLS.
>
> ​	当新节点加入 Swarm 时，您不需要解锁 Swarm，因为密钥会通过互相 TLS 传播给新节点。

## 使用自动锁定启用新的 Swarm - Initialize a swarm with autolocking enabled

When you initialize a new swarm, you can use the `--autolock` flag to enable autolocking of swarm manager nodes when Docker restarts.

​	当您初始化新 Swarm 时，可以使用 `--autolock` 参数启用 Swarm 管理节点在 Docker 重启时的自动锁定功能。

```console
$ docker swarm init --autolock

Swarm initialized: current node (k1q27tfyx9rncpixhk69sa61v) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-0j52ln6hxjpxk2wgk917abcnxywj3xed0y8vi1e5m9t3uttrtu-7bnxvvlz2mrcpfonjuztmtts9 \
    172.31.46.109:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-WuYH/IX284+lRcXuoVf38viIDK3HJEKY13MIHX+tTt8
```

Store the key in a safe place, such as in a password manager.

​	将此密钥存储在安全的位置，例如密码管理器中。

When Docker restarts, you need to [unlock the swarm](https://docs.docker.com/engine/swarm/swarm_manager_locking/#unlock-a-swarm). A locked swarm causes an error like the following when you try to start or restart a service:

​	当 Docker 重启时，您需要 [解锁 Swarm](https://docs.docker.com/engine/swarm/swarm_manager_locking/#unlock-a-swarm)。如果 Swarm 被锁定，尝试启动或重启服务时将会出现类似以下的错误：

```console
$ sudo service docker restart

$ docker service ls

Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Use "docker swarm unlock" to unlock it.
```

## 在现有 Swarm 上启用或禁用自动锁定 Enable or disable autolock on an existing swarm

To enable autolock on an existing swarm, set the `autolock` flag to `true`.

​	在现有 Swarm 上启用自动锁定，将 `autolock` 标志设置为 `true`。



```console
$ docker swarm update --autolock=true

Swarm updated.
To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-+MrE8NgAyKj5r3NcR4FiQMdgu+7W72urH0EZeSmP/0Y

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
```

To disable autolock, set `--autolock` to `false`. The mutual TLS key and the encryption key used to read and write Raft logs are stored unencrypted on disk. There is a trade-off between the risk of storing the encryption key unencrypted at rest and the convenience of restarting a swarm without needing to unlock each manager.

​	若要禁用自动锁定，将 `--autolock` 设置为 `false`。此时，互相 TLS 密钥以及用于读写 Raft 日志的加密密钥将会在磁盘上未加密存储。需要在便利性和加密风险之间做出权衡。



```console
$ docker swarm update --autolock=false
```

Keep the unlock key around for a short time after disabling autolocking, in case a manager goes down while it is still configured to lock using the old key.

​	禁用自动锁定后，建议短时间内保留解锁密钥，以防管理节点在配置仍为旧密钥的状态下宕机。

## 解锁 Swarm Unlock a swarm

To unlock a locked swarm, use `docker swarm unlock`.

​	若要解锁被锁定的 Swarm，请使用 `docker swarm unlock`。



```console
$ docker swarm unlock

Please enter unlock key:
```

Enter the encryption key that was generated and shown in the command output when you locked the swarm or rotated the key, and the swarm unlocks.

​	输入锁定 Swarm 或旋转密钥时生成并显示的加密密钥，Swarm 将会解锁。

## 查看正在运行的 Swarm 的当前解锁密钥 View the current unlock key for a running swarm

Consider a situation where your swarm is running as expected, then a manager node becomes unavailable. You troubleshoot the problem and bring the physical node back online, but you need to unlock the manager by providing the unlock key to read the encrypted credentials and Raft logs.

​	在 Swarm 正常运行的情况下，如果某个管理节点不可用，您需要在故障排除后重新启动该物理节点，并提供解锁密钥以读取加密的凭据和 Raft 日志。

If the key has not been rotated since the node left the swarm, and you have a quorum of functional manager nodes in the swarm, you can view the current unlock key using `docker swarm unlock-key` without any arguments.

​	如果节点离开 Swarm 后密钥未发生轮换，且 Swarm 中仍有功能正常的管理节点达成共识，您可以使用不带参数的 `docker swarm unlock-key` 查看当前解锁密钥。



```console
$ docker swarm unlock-key

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-8jDgbUNlJtUe5P/lcr9IXGVxqZpZUXPzd+qzcGp4ZYA

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
```

If the key was rotated after the swarm node became unavailable and you do not have a record of the previous key, you may need to force the manager to leave the swarm and join it back to the swarm as a new manager.

​	如果节点离开 Swarm 后密钥已发生轮换，且您没有之前的密钥记录，则可能需要强制该管理节点离开 Swarm，并将其重新加入为新的管理节点。

## 轮换解锁密钥 Rotate the unlock key

You should rotate the locked swarm's unlock key on a regular schedule.

​	建议定期轮换锁定的 Swarm 解锁密钥。

```console
$ docker swarm unlock-key --rotate

Successfully rotated manager unlock key.

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-8jDgbUNlJtUe5P/lcr9IXGVxqZpZUXPzd+qzcGp4ZYA

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
```

> **Warning**
>
> 
>
> When you rotate the unlock key, keep a record of the old key around for a few minutes, so that if a manager goes down before it gets the new key, it may still be unlocked with the old one.
>
> ​	当您轮换解锁密钥时，建议保留旧密钥几分钟。如果某个管理节点在获得新密钥前宕机，仍可使用旧密钥解锁。
