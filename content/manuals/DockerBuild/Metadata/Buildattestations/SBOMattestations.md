+++
title = "SBOM 声明"
date = 2024-10-23T14:54:40+08:00
weight = 30
type = "docs"
description = ""
isCJKLanguage = true
draft = false

+++

> 原文：[https://docs.docker.com/build/metadata/attestations/sbom/](https://docs.docker.com/build/metadata/attestations/sbom/)
>
> 收录该文档的时间：`2024-10-23T14:54:40+08:00`

# SBOM attestations - SBOM 声明

Software Bill of Materials (SBOM) attestations describe what software artifacts an image contains, and artifacts used to create the image. Metadata included in an SBOM for describing software artifacts may include:

​	软件物料清单 (SBOM) 声明描述了镜像包含的软件工件及用于创建镜像的工件。SBOM 中描述软件工件的元数据可能包括：

- Name of the artifact
  - 工件名称

- Version
  - 版本

- License type
  - 许可证类型

- Authors
  - 作者

- Unique package identifier
  - 唯一包标识符


There are benefits to indexing contents of an image during the build, as opposed to scanning a final image. When scanning happens as part of the build, you're able to detect software you use to build the image, that may not show up in the final image.

​	在构建过程中索引镜像内容相对于扫描最终镜像有诸多优势。当扫描作为构建的一部分进行时，您可以检测到用于构建镜像的软件，即使它可能不会显示在最终镜像中。

The SBOMs generated by BuildKit follow the SPDX standard. SBOMs attach to the final image as a JSON-encoded SPDX document, using the format defined by the [in-toto SPDX predicate](https://github.com/in-toto/attestation/blob/main/spec/predicates/spdx.md).

​	BuildKit 生成的 SBOM 遵循 SPDX 标准。SBOM 附加到最终镜像上，作为使用 [in-toto SPDX 谓词](https://github.com/in-toto/attestation/blob/main/spec/predicates/spdx.md) 定义的 JSON 编码 SPDX 文档。

## 创建 SBOM 声明 Create SBOM attestations

To create an SBOM attestation, pass the `--attest type=sbom` option to the `docker buildx build` command:

​	要创建 SBOM 声明，可在 `docker buildx build` 命令中传递 `--attest type=sbom` 选项：



```console
$ docker buildx build --tag <namespace>/<image>:<version> \
    --attest type=sbom --push .
```

Alternatively, you can use the shorthand `--sbom=true` option instead of `--attest type=sbom`.

​	或者，可以使用简写选项 `--sbom=true` 代替 `--attest type=sbom`。

For an example on how to add SBOM attestations with GitHub Actions, see [Add attestations with GitHub Actions]({{< ref "/manuals/DockerBuild/CI/GitHubActions/Attestations" >}}).

​	关于如何使用 GitHub Actions 添加 SBOM 声明的示例，请参阅 [使用 GitHub Actions 添加声明]({{< ref "/manuals/DockerBuild/CI/GitHubActions/Attestations" >}})。

## 验证 SBOM 声明 Verify SBOM attestations

Always validate the generated SBOM for your image before you push your image to a registry.

​	在将镜像推送到注册表之前，始终验证生成的 SBOM。

To validate, you can build the image using the `local` exporter. Building with the `local` exporter saves the build result to your local filesystem instead of creating an image. Attestations are written to a JSON file in the root directory of your export.

​	要验证，可以使用 `local` 导出器构建镜像。使用 `local` 导出器构建时，将构建结果保存到本地文件系统，而不是创建镜像。声明将写入到导出根目录中的 JSON 文件中。



```console
$ docker buildx build \
  --sbom=true \
  --output type=local,dest=out .
```

The SBOM file appears in the root directory of the output, named `sbom.spdx.json`:

​	在输出的根目录中，SBOM 文件被命名为 `sbom.spdx.json`：



```console
$ ls -1 ./out | grep sbom
sbom.spdx.json
```

## 参数 Arguments

By default, BuildKit only scans the final stage of an image. The resulting SBOM doesn't include build-time dependencies installed in earlier stages, or that exist in the build context. This may cause you to overlook vulnerabilities in those dependencies, which could impact the security of your final build artifacts.

​	默认情况下，BuildKit 仅扫描镜像的最终阶段。生成的 SBOM 不包含在早期阶段安装的构建时依赖项或存在于构建上下文中的依赖项。这可能导致忽略这些依赖项中的漏洞，从而影响最终构建工件的安全性。

For instance, you might use [multi-stage builds]({{< ref "/manuals/DockerBuild/Building/Multi-stage" >}}), with a `FROM scratch` stanza for your final stage to achieve a smaller image size.

​	例如，您可能使用了 [多阶段构建]({{< ref "/manuals/DockerBuild/Building/Multi-stage" >}})，在最终阶段使用 `FROM scratch` 语句以实现较小的镜像大小。



```dockerfile
FROM alpine AS build
# build the software ...

FROM scratch
COPY --from=build /path/to/bin /bin
ENTRYPOINT [ "/bin" ]
```

Scanning the resulting image built using this Dockerfile example would not reveal build-time dependencies used in the `build` stage.

​	扫描此 Dockerfile 示例构建的镜像将不会揭示在 `build` 阶段中使用的构建时依赖项。

To include build-time dependencies from your Dockerfile, you can set the build arguments `BUILDKIT_SBOM_SCAN_CONTEXT` and `BUILDKIT_SBOM_SCAN_STAGE`. This expands the scanning scope to include the build context and additional stages.

​	要包含 Dockerfile 中的构建时依赖项，可以设置构建参数 `BUILDKIT_SBOM_SCAN_CONTEXT` 和 `BUILDKIT_SBOM_SCAN_STAGE`。这将扩展扫描范围以包含构建上下文和附加阶段。

You can set the arguments as global arguments (after declaring the Dockerfile syntax directive, before the first `FROM` command) or individually in each stage. If set globally, the value propagates to each stage in the Dockerfile.

​	可以将这些参数作为全局参数（在声明 Dockerfile 语法指令后、在第一个 `FROM` 命令之前）或在每个阶段单独设置。如果全局设置，则该值会传播到 Dockerfile 中的每个阶段。

The `BUILDKIT_SBOM_SCAN_CONTEXT` and `BUILDKIT_SBOM_SCAN_STAGE` build arguments are special values. You can't perform variable substitution using these arguments, and you can't set them using environment variables from within the Dockerfile. The only way to set these values is using explicit `ARG` command in the Dockerfile.

​	`BUILDKIT_SBOM_SCAN_CONTEXT` 和 `BUILDKIT_SBOM_SCAN_STAGE` 构建参数是特殊值。无法使用这些参数进行变量替换，也无法在 Dockerfile 中使用环境变量设置它们。唯一的方法是在 Dockerfile 中显式使用 `ARG` 命令设置这些值。

### 扫描构建上下文 Scan build context

To scan the build context, set the `BUILDKIT_SBOM_SCAN_CONTEXT` to `true`.

​	要扫描构建上下文，将 `BUILDKIT_SBOM_SCAN_CONTEXT` 设置为 `true`。



```dockerfile
# syntax=docker/dockerfile:1
ARG BUILDKIT_SBOM_SCAN_CONTEXT=true
FROM alpine AS build
# ...
```

You can use the `--build-arg` CLI option to override the value specified in the Dockerfile.

​	可以使用 `--build-arg` CLI 选项覆盖 Dockerfile 中指定的值。



```console
$ docker buildx build --tag <image>:<version> \
    --attest type=sbom \
    --build-arg BUILDKIT_SBOM_SCAN_CONTEXT=false .
```

Note that passing the option as a CLI argument only, without having declared it using `ARG` in the Dockerfile, will have no effect. You must specify the `ARG` in the Dockerfile, whereby you can override the context scanning behavior using `--build-arg`.

​	请注意，仅作为 CLI 参数传递选项而未在 Dockerfile 中声明 `ARG` 将无效。必须在 Dockerfile 中指定 `ARG`，然后可使用 `--build-arg` 覆盖上下文扫描行为。

### 扫描阶段 Scan stages

To scan more than just the final stage, set the `BUILDKIT_SBOM_SCAN_STAGE` argument to true, either globally or in the specific stages that you want to scan. The following table demonstrates the different possible settings for this argument.

​	要扫描除最终阶段之外的其他阶段，将 `BUILDKIT_SBOM_SCAN_STAGE` 参数设置为 true，既可全局设置，也可在特定阶段中设置。以下表格展示了此参数的不同设置可能性。

| Value                               | Description                                                  |
| ----------------------------------- | ------------------------------------------------------------ |
| `BUILDKIT_SBOM_SCAN_STAGE=true`     | 启用当前阶段的扫描 Enables scanning for the current stage    |
| `BUILDKIT_SBOM_SCAN_STAGE=false`    | 禁用当前阶段的扫描 Disables scanning for the current stage   |
| `BUILDKIT_SBOM_SCAN_STAGE=base,bin` | 启用对名称为 `base` 和 `bin` 的阶段进行扫描 Enables scanning for the stages named `base` and `bin` |

Only stages that are built will be scanned. Stages that aren't dependencies of the target stage won't be built, or scanned.

​	仅构建的阶段将被扫描。未作为目标阶段的依赖的阶段不会被构建或扫描。

The following Dockerfile example uses multi-stage builds to build a static website with [Hugo](https://gohugo.io/).

​	以下 Dockerfile 示例使用多阶段构建生成一个静态网站并使用 [Hugo](https://gohugo.io/)：

```dockerfile
# syntax=docker/dockerfile:1
FROM alpine as hugo
ARG BUILDKIT_SBOM_SCAN_STAGE=true
WORKDIR /src
COPY <<config.yml ./
title: My Hugo website
config.yml
RUN apk add --upgrade hugo && hugo

FROM scratch
COPY --from=hugo /src/public /
```

Setting `ARG BUILDKIT_SBOM_SCAN_STAGE=true` in the `hugo` stage ensures that the final SBOM includes the information that Alpine Linux and Hugo were used to create the website.

​	在 `hugo` 阶段设置 `ARG BUILDKIT_SBOM_SCAN_STAGE=true` 确保最终生成的 SBOM 包含使用了 Alpine Linux 和 Hugo 构建网站的信息。

Building this image with the `local` exporter creates two JSON files:

​	使用 `local` 导出器构建该镜像会创建两个 JSON 文件：



```console
$ docker buildx build \
  --sbom=true \
  --output type=local,dest=out .
$ ls -1 out | grep sbom
sbom-hugo.spdx.json
sbom.spdx.json
```

## 检查 SBOM - Inspecting SBOMs

To explore created SBOMs exported through the `image` exporter, you can use [`imagetools inspect`]({{< ref "/reference/CLIreference/docker/dockerbuildx/dockerbuildximagetools/dockerbuildximagetoolsinspect" >}}).

​	要检查通过 `image` 导出器导出的 SBOM，可以使用 [`imagetools inspect`]({{< ref "/reference/CLIreference/docker/dockerbuildx/dockerbuildximagetools/dockerbuildximagetoolsinspect" >}})。

Using the `--format` option, you can specify a template for the output. All SBOM-related data is available under the `.SBOM` attribute. For example, to get the raw contents of an SBOM in SPDX format:

​	使用 `--format` 选项可以指定输出模板。所有 SBOM 相关数据均可在 `.SBOM` 属性下找到。例如，获取 SPDX 格式的原始 SBOM 内容：





```console
$ docker buildx imagetools inspect <namespace>/<image>:<version> \
    --format "{{ json .SBOM.SPDX }}"
{
  "SPDXID": "SPDXRef-DOCUMENT",
  ...
}
```

> **Tip**
>
> 
>
> If the image is multi-platform, you can check the SBOM for a platform-specific index using `--format '{{ json (index .SBOM "linux/amd64").SPDX }}'`.
>
> ​	如果镜像是多平台的，可以使用 `--format '{{ json (index .SBOM "linux/amd64").SPDX }}'` 检查特定平台索引的 SBOM。

You can also construct more complex expressions using the full functionality of Go templates. For example, you can list all the installed packages and their version identifiers:

​	您还可以使用 Go 模板的完整功能构造更复杂的表达式。例如，可以列出所有安装的软件包及其版本标识符：

```console
$ docker buildx imagetools inspect <namespace>/<image>:<version> \
    --format "{{ range .SBOM.SPDX.packages }}{{ .name }}@{{ .versionInfo }}{{ println }}{{ end }}"
adduser@3.118ubuntu2
apt@2.0.9
base-files@11ubuntu5.6
base-passwd@3.5.47
...
```

## SBOM 生成器 SBOM generator

BuildKit generates the SBOM using a scanner plugin. By default, it uses is the [BuildKit Syft scanner](https://github.com/docker/buildkit-syft-scanner) plugin. This plugin is built on top of [Anchore's Syft](https://github.com/anchore/syft), an open source tool for generating an SBOM.

​	BuildKit 使用扫描插件生成 SBOM。默认情况下，它使用的是 [BuildKit Syft 扫描器](https://github.com/docker/buildkit-syft-scanner) 插件。此插件构建在开源工具 [Anchore 的 Syft](https://github.com/anchore/syft) 之上，用于生成 SBOM。		

You can select a different plugin to use with the `generator` option, specifying an image that implements the [BuildKit SBOM scanner protocol](https://github.com/moby/buildkit/blob/master/docs/attestations/sbom-protocol.md).

​	可以使用 `generator` 选项选择其他插件，指定实现了 [BuildKit SBOM 扫描器协议](https://github.com/moby/buildkit/blob/master/docs/attestations/sbom-protocol.md) 的镜像。



```console
$ docker buildx build --attest type=sbom,generator=<image> .
```

> **Tip**
>
> 
>
> The Docker Scout SBOM generator is available. See [Docker Scout SBOMs]({{< ref "/manuals/DockerScout/How-tos/DockerScoutSBOMs" >}}).
>
> ​	Docker Scout SBOM 生成器可用。参见 [Docker Scout SBOMs]({{< ref "/manuals/DockerScout/How-tos/DockerScoutSBOMs" >}})。

## SBOM 声明示例 SBOM attestation example

The following JSON example shows what an SBOM attestation might look like.

​	以下 JSON 示例展示了一个 SBOM 声明的可能格式。

```json
{
  "_type": "https://in-toto.io/Statement/v0.1",
  "predicateType": "https://spdx.dev/Document",
  "subject": [
    {
      "name": "pkg:docker/<registry>/<image>@<tag/digest>?platform=<platform>",
      "digest": {
        "sha256": "e8275b2b76280af67e26f068e5d585eb905f8dfd2f1918b3229db98133cb4862"
      }
    }
  ],
  "predicate": {
    "SPDXID": "SPDXRef-DOCUMENT",
    "creationInfo": {
      "created": "2022-12-16T15:27:25.517047753Z",
      "creators": ["Organization: Anchore, Inc", "Tool: syft-v0.60.3"],
      "licenseListVersion": "3.18"
    },
    "dataLicense": "CC0-1.0",
    "documentNamespace": "https://anchore.com/syft/dir/run/src/core/sbom-cba61a72-fa95-4b60-b63f-03169eac25ca",
    "name": "/run/src/core/sbom",
    "packages": [
      {
        "SPDXID": "SPDXRef-b074348b8f56ea64",
        "downloadLocation": "NOASSERTION",
        "externalRefs": [
          {
            "referenceCategory": "SECURITY",
            "referenceLocator": "cpe:2.3:a:org:repo:\\(devel\\):*:*:*:*:*:*:*",
            "referenceType": "cpe23Type"
          },
          {
            "referenceCategory": "PACKAGE_MANAGER",
            "referenceLocator": "pkg:golang/github.com/org/repo@(devel)",
            "referenceType": "purl"
          }
        ],
        "filesAnalyzed": false,
        "licenseConcluded": "NONE",
        "licenseDeclared": "NONE",
        "name": "github.com/org/repo",
        "sourceInfo": "acquired package info from go module information: bin/server",
        "versionInfo": "(devel)"
      },
      {
        "SPDXID": "SPDXRef-1b96f57f8fed62d8",
        "checksums": [
          {
            "algorithm": "SHA256",
            "checksumValue": "0c13f1f3c1636491f716c2027c301f21f9dbed7c4a2185461ba94e3e58443408"
          }
        ],
        "downloadLocation": "NOASSERTION",
        "externalRefs": [
          {
            "referenceCategory": "SECURITY",
            "referenceLocator": "cpe:2.3:a:go-chi:chi\\/v5:v5.0.0:*:*:*:*:*:*:*",
            "referenceType": "cpe23Type"
          },
          {
            "referenceCategory": "SECURITY",
            "referenceLocator": "cpe:2.3:a:go_chi:chi\\/v5:v5.0.0:*:*:*:*:*:*:*",
            "referenceType": "cpe23Type"
          },
          {
            "referenceCategory": "SECURITY",
            "referenceLocator": "cpe:2.3:a:go:chi\\/v5:v5.0.0:*:*:*:*:*:*:*",
            "referenceType": "cpe23Type"
          },
          {
            "referenceCategory": "PACKAGE_MANAGER",
            "referenceLocator": "pkg:golang/github.com/go-chi/chi/v5@v5.0.0",
            "referenceType": "purl"
          }
        ],
        "filesAnalyzed": false,
        "licenseConcluded": "NONE",
        "licenseDeclared": "NONE",
        "name": "github.com/go-chi/chi/v5",
        "sourceInfo": "acquired package info from go module information: bin/server",
        "versionInfo": "v5.0.0"
      }
    ],
    "relationships": [
      {
        "relatedSpdxElement": "SPDXRef-1b96f57f8fed62d8",
        "relationshipType": "CONTAINS",
        "spdxElementId": "SPDXRef-043f7360d3c66bc31ba45388f16423aa58693289126421b71d884145f8837fe1"
      },
      {
        "relatedSpdxElement": "SPDXRef-b074348b8f56ea64",
        "relationshipType": "CONTAINS",
        "spdxElementId": "SPDXRef-043f7360d3c66bc31ba45388f16423aa58693289126421b71d884145f8837fe1"
      }
    ],
    "spdxVersion": "SPDX-2.2"
  }
}
```
